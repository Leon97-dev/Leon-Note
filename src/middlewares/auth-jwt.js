// TODO) Auth: 요청마다 실행되는 커스텀 로직
// ?) JWT 기반 로그인 여부를 검사하는 인증 미들웨어
// &) Service Import
import { authService } from '../services/auth-service.js';

export function requireAuth(req, res, next) {
  const auth = req.headers.authorization || '';
  const [type, token] = auth.split(' ');

  if (type !== 'Bearer' || !token) {
    return res.status(401).json({
      success: false,
      message: '승인 헤더가 없거나 형식이 잘못되었습니다',
    });
  }

  try {
    const decoded = authService.verifyAccessToken(token);
    req.user = { id: decoded.id, email: decoded.email };

    return next();
  } catch (error) {
    return res.status(401).json({
      success: false,
      message: '유효하지 않거나 만료된 토큰입니다',
    });
  }
}

/**
 * ------------------------------------------------------------
 * &) 왜 auth.js 가 필요한가?
 * ------------------------------------------------------------
 * requireAuth는 모든 "보호된 API"의 문지기 역할을 한다.
 * 즉, 로그인하지 않은 사용자의 접근을 막고
 * 정상적인 JWT만 통과시키는 인증 레이어다.
 *
 * Express 요청 흐름에서 미들웨어는 컨트롤러보다 먼저 실행되므로
 * 컨트롤러에서는 인증/인가 로직을 걱정할 필요가 없다.
 *
 * ------------------------------------------------------------
 * &) 처리 흐름 요약
 * ------------------------------------------------------------
 * 1) 요청 헤더의 Authorization 값 확인
 *    - "Bearer <token>" 구조인지 검사
 *
 * 2) 토큰 검증
 *    - authService.verifyAccessToken() 호출
 *    - 유효한 JWT면 payload 반환
 *
 * 3) req.user 주입
 *    - 이후 컨트롤러와 서비스에서 로그인 정보를 읽을 수 있음
 *
 * 4) 에러 처리
 *    - 토큰 없거나 형식 잘못됨 → 401
 *    - 서명 위조/만료된 토큰 → 401
 *
 * ------------------------------------------------------------
 * &) 어떤 API에 사용해야 하는가?
 * ------------------------------------------------------------
 * ✔ 내 정보 조회 / 수정
 * ✔ 게시글 작성, 수정, 삭제
 * ✔ 댓글 작성, 수정, 삭제
 * ✔ 장바구니, 결제 등 유저 상태가 필요한 모든 API
 *
 * 단순 목록 조회나 공개 정보 조회에는 사용하지 않는다.
 *
 * ------------------------------------------------------------
 * &) 왜 라우터에서 호출하는가?
 * ------------------------------------------------------------
 * requireAuth는 "요청을 통째로 검사"하는 기능이므로
 * 컨트롤러보다 라우터에 붙여야 가장 깔끔하다.
 *
 * 예시:
 *   router.post('/articles', requireAuth, asyncHandler(createArticle));
 *
 * 이렇게 하면 createArticle 내부는 인증 걱정 없이
 * 순수한 비즈니스 로직만 작성할 수 있다.
 *
 * ------------------------------------------------------------
 * &) 결론
 * ------------------------------------------------------------
 * requireAuth는 실제 서비스에서 가장 자주 쓰는 인증 미들웨어이며,
 * 인증 책임을 서비스/컨트롤러와 명확하게 분리해 코드의 안정성과 유지보수성을 높여준다.
 */
