// TODO) Role: 요청마다 실행되는 커스텀 로직
// ?) 특정 역할(role)만 접근하도록 제한하는 RBAC(Role-Based Access Control) 미들웨어

export function requireRole(...roles) {
  return (req, res, next) => {
    const role = req.user?.role;

    // *) 역할 정보가 없거나 허용된 역할이 아닌 경우
    if (!role || !roles.includes(role)) {
      return res.status(403).json({
        success: false,
        message: '해당 역할의 권한이 없습니다',
      });
    }

    next();
  };
}

/**
 * ------------------------------------------------------------
 * &) 왜 role.js(또는 requireRole)가 필요한가?
 * ------------------------------------------------------------
 * requireRole은 “특정 역할(Role)만 접근할 수 있는 API”를 보호하는 미들웨어다.
 * 로그인 여부는 requireAuth가 검사하고,
 * 그 다음 단계에서 “권한(Authorization)”을 검사하는 게 이 미들웨어의 역할이다.
 *
 * 즉, 인증(Auth) 다음에 실행되는 인가(Role) 레이어다.
 *
 * 사용자 권한을 컨트롤러나 서비스 안에서 매번 검사하면
 * - 중복 코드 증가
 * - 로직 오염
 * - 유지보수 난이도 상승
 * 이 문제가 발생하므로, 역할 검사는 반드시 미들웨어에서 수행하는 것이 정석이다.
 *
 * ------------------------------------------------------------
 * &) 처리 흐름 요약
 * ------------------------------------------------------------
 * 1) req.user.role 존재 여부 확인
 *    → requireAuth에서 토큰 검증 후 주입된 값
 *
 * 2) API에서 허용한 역할 목록과 비교
 *    예: requireRole('admin', 'seller')
 *
 * 3) 권한 없음 → 403 Forbidden 응답
 *    message: '해당 역할의 권한이 없습니다'
 *
 * 4) 권한 있음 → next()로 컨트롤러 진행
 *
 * ------------------------------------------------------------
 * &) 어떤 API에 필요할까?
 * ------------------------------------------------------------
 * ✔ 관리자(Admin) 전용 API
 *    - 회원 관리 전체 조회
 *    - 게시글/상품 강제 삭제
 *
 * ✔ 판매자(Seller) 전용 API
 *    - 상품 등록/수정/삭제
 *
 * ✔ 조직/부서별 권한이 다른 경우
 *    - manager만 가능
 *    - staff 제한 등
 *
 * ✔ 유저와 판매자 등 역할이 나뉘는 서비스에서 필수
 *
 * 일반 유저도 접근 가능한 공개 API에는 사용하지 않는다.
 *
 * ------------------------------------------------------------
 * &) 왜 라우터에서 호출해야 하는가?
 * ------------------------------------------------------------
 * 역할(Role) 확인은 “요청 전체”를 판별하는 기능이다.
 *
 * 라우터 예시:
 *   router.delete('/products/:id',
 *     requireAuth,
 *     requireRole('admin', 'seller'),
 *     asyncHandler(removeProduct)
 *   );
 *
 * 이렇게 배치하면 컨트롤러는 오직 비즈니스 로직만 담당한다.
 * 컨트롤러 내부에 if(role !== 'admin') 같은 조건문이 사라져 코드가 깔끔해진다.
 *
 * ------------------------------------------------------------
 * &) 필요한 경우 확장도 쉽다
 * ------------------------------------------------------------
 * - 계층형 권한 (admin > manager > user)
 * - 리소스 소유권 검사 (ownerId === req.user.id)
 * - 조직/팀 기반 권한 제어
 * - 시간/상태 기반 조건부 권한
 *
 * 지금 형태는 가볍고 확장성 높은 기본 구현으로 매우 적절하다.
 *
 * ------------------------------------------------------------
 * &) 결론
 * ------------------------------------------------------------
 * requireRole은 RBAC(Role-Based Access Control)를 구현하는 핵심 미들웨어다.
 * 인증 ⇢ 인가 구조를 명확하게 분리해
 * 컨트롤러/서비스의 복잡도를 줄이고 유지보수성을 크게 높여준다.
 */
