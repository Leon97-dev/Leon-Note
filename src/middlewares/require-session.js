// TODO) Require-Session: 요청마다 실행되는 커스텀 로직
// ?) Session 기반 로그인 여부를 검사하는 인증 미들웨어
// &) Core Import
import { UnauthorizedError } from '../core/error/error-handler.js';

export default function requireSession(req, _res, next) {
  if (!req.session?.userId) {
    throw new UnauthorizedError('로그인이 필요합니다');
  }

  next();
}

/**
 * ------------------------------------------------------------
 * &) 왜 requireSession 미들웨어가 필요한가?
 * ------------------------------------------------------------
 * 서버 기반 인증(Session Auth)은 로그인하면
 *   - 서버 메모리 / Redis / PostgreSQL 등에 세션을 저장하고
 *   - 클라이언트 브라우저에는 sid(세션 ID)만 쿠키로 저장한다.
 *
 * 이후 요청마다 브라우저가 쿠키를 자동 전송하면
 * 서버는 해당 sid로 다시 userId 등을 복구한다.
 *
 * requireSession은 이 userId가 존재하는지 확인하는 문지기다.
 *
 * ------------------------------------------------------------
 * &) 처리 흐름 요약
 * ------------------------------------------------------------
 * 1) req.session.userId 존재 여부 확인
 *    → 세션 미들웨어(sessionMiddleware)에서 자동 생성됨
 *
 * 2) userId가 없으면 UnauthorizedError 발생
 *
 * 3) userId가 있으면 정상적인 로그인 상태 → next()로 진행
 *
 * ------------------------------------------------------------
 * &) 어떤 API에 적용해야 하는가?
 * ------------------------------------------------------------
 * ✔ 내 정보 조회 / 수정
 * ✔ 게시글 작성, 수정, 삭제
 * ✔ 댓글 작성, 수정, 삭제
 * ✔ 장바구니 / 결제 / 주문 API
 *
 * 즉, 로그인한 사용자만 접근 가능한 모든 API에 필수.
 *
 * ------------------------------------------------------------
 * &) JWT(requireAuth) 방식과 비교
 * ------------------------------------------------------------
 * ✔ JWT 방식(requireAuth)
 *    → Authorization 헤더로 토큰 전달
 *    → 서버가 stateless (세션 저장 필요 없음)
 *
 * ✔ Session 방식(requireSession)
 *    → 쿠키(sid) 기반
 *    → 서버가 세션 저장소(메모리/Redis/DB)를 관리
 *
 * 둘 다 미들웨어에서 인증을 처리하는 구조는 동일하며
 * 인증 로직을 분리함으로써 컨트롤러는 깨끗하게 유지된다.
 *
 * ------------------------------------------------------------
 * &) 왜 컨트롤러가 아니라 미들웨어인가?
 * ------------------------------------------------------------
 * 인증은 “요청 전체”에 대한 검증이며
 * 컨트롤러가 받기도 전에 인증 여부를 판단해야 한다.
 *
 * 따라서 requireSession은 Router 레이어에서 붙이는 것이 정석.
 *
 * 예:
 *   router.post('/articles', requireSession, asyncHandler(createArticle));
 *
 * 컨트롤러는 userId만 믿고 비즈니스 로직만 집중하면 된다.
 *
 * ------------------------------------------------------------
 * &) 결론
 * ------------------------------------------------------------
 * requireSession은 세션기반 인증의 핵심 포인트이며,
 * 역할(문지기)과 책임(로그인 여부 확인)이 명확하므로
 * 미들웨어로 분류하는 것이 구조적으로 가장 깔끔하다.
 */
