// TODO) CORS: 프론트에서 백엔드로 요청 허용 설정 (기본 보안)
// ?) origin 은 나중에 실제 배포 주소로 변경 필요
import './env.js';
import cors from 'cors';

const allowedOrigins = [
  process.env.CLIENT_URL, // .env에서 명시한 프론트 주소
  'http://localhost:3000', // 개발용
];

export const corsOptions = cors({
  origin: (origin, callback) => {
    // origin이 없는 경우(예: Postman) 허용
    if (!origin) return callback(null, true);

    // 허용된 도메인만 받아줌
    if (allowedOrigins.includes(origin)) {
      return callback(null, true);
    }

    // 나머지는 차단
    return callback(new Error('CORS 정책에 의해 차단된 요청입니다'), false);
  },

  credentials: true, // 인증/쿠키 필요할 때 true
});

// !) CORS 실제 환경에 따라 코드나 버전이 달라진다.
// ~) 완전 공개 모드(테스트용)
// ~) 쿠키 기반 인증을 위한 구성 강화 버전
// ~) Next.js 연동에 최적화된 버전
// ~) 프록시/Cloudflare 환경에서 안정적인 버전

/**
 * -------------------------------
 * [CORS: 프론트 → 백엔드 접근 제어 설정]
 * -------------------------------
 *
 * &) 목적
 * 브라우저는 보안 때문에, 다른 도메인(프론트)에서 백엔드 API로 요청할 때
 * 기본적으로 차단한다. CORS 설정은 “어떤 프론트 주소(origin)를 허용할지”
 * 백엔드가 직접 명시해주기 위한 보안 장치다.
 *
 * &) 문제 상황의 원인
 * 프론트와 백엔드가 다른 주소(포트 포함)에 있을 때
 * CORS가 허용되지 않으면 요청 자체가 브라우저 단계에서 막힌다.
 * 이 때문에 프론트에서는 정상인데 네트워크 탭에서 요청이 실패하는
 * 헷갈리는 버그가 실제로 자주 발생한다.
 *
 * -------------------------------
 * [실무에서 자주 발생하는 CORS 문제들]
 * -------------------------------
 *
 * 1) 허용 origin을 잘못 설정해서 정상적인 프론트 요청도 차단됨
 *    → 개발 환경과 배포 환경 주소가 달라 문제 발생
 *
 * 2) credentials(쿠키) 옵션 누락
 *    → 로그인/세션 기반 인증이 갑자기 안 됨
 *
 * 3) 프록시/Cloudflare/Vercel/NGINX 사용 시
 *    → 실제 origin과 다르게 인식되어 CORS가 예상대로 작동하지 않음
 *
 * 4) 테스트(Postman, cURL)는 origin이 없어서 잘 되는데
 *    브라우저에서는 요청이 막혀 개발자가 혼란스러움
 *
 * -------------------------------
 * [왜 CORS 설정이 버전별로 달라질까?]
 * -------------------------------
 * - 완전 공개 모드(테스트용)
 *   → 모든 origin 허용: 개발 편하지만 보안은 거의 없음.
 *
 * - 쿠키 기반 인증 강화 모드
 *   → credentials:true 설정 + SameSite 정책 필요.
 *
 * - Next.js와 연동되는 환경
 *   → 로컬 dev 서버 주소와 배포 주소가 다르므로,
 *     여러 origin을 허용리스트에 넣어야 한다.
 *
 * - Cloudflare/프록시 환경
 *   → 실제 요청 origin이 프록시 주소로 바뀌기 때문에
 *     허용 domain을 더 넓게 잡거나 정교한 필터링이 필요함.
 *
 * -------------------------------
 * [정리]
 * -------------------------------
 * CORS는 단순히 “true/false” 문제가 아니라,
 * 인증 방식, 배포 구조, 프론트 환경에 따라 달라지는 보안 설정이다.
 * 그래서 config 폴더에서 중앙에서 제어하는 것이 가장 안정적인 구조다.
 */
