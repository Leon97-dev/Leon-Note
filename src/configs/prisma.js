// TODO) Prisma-Singleton: 환경, 설정, 공통 미들웨어 정의
// ?) PrismaClient DB 연결 중복 예방
import './env.js';
// ^) PrismaClient가 생성되기 전에 .env를 반드시 로드해야 오류 안터짐!
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient({
  log:
    process.env.DEBUG_MODE === 'true'
      ? ['query', 'info', 'warn', 'error'] // ← 개발: 모든 로그 출력
      : ['error'], // ← 배포: 에러 로그만 출력
});

/**
 * &) process.env.DEBUG_MODE === 'true'
 * .env 파일에 DEBUG_MODE=
 * true면 개발 모드, false면 배포 모드
 * 이 값을 기준으로 아래 로그 레벨이 자동 결정된다.
 *
 * &) ['query', 'info', 'warn', 'error']
 * query → Prisma가 DB에 날린 SQL 보기 (예: SELECT * FROM users …)
 * info → Prisma 내부 정보
 * warn → 경고
 * error → 에러
 * 개발 중이라면 SQL까지 모두 보이는 게 디버깅에 최고라 이 옵션이 엄청 유용함
 *
 * &) 배포 모드: 에러만
 * 운영 환경에서는:
 * SQL 로그가 출력되면 보안 위험
 * 로그 양이 너무 많아서 서버 비용 증가
 * 콘솔 로그가 쓸데없이 쌓여 분석이 어려움
 * 그래서 error만 출력하는 것이 완전 정석이다.
 */

export default prisma;

/**
 * -------------------------------
 * [Prisma Singleton: 역할과 필요성]
 * -------------------------------
 *
 * &) 목적
 * PrismaClient는 데이터베이스와 연결을 맺는 핵심 객체이다.
 * 하지만 이 인스턴스를 매번 새로 만들면 커넥션이 중복 생성되어
 * 메모리 누수, 연결 폭주, 서버 다운 같은 문제가 실제로 발생한다.
 * 그래서 PrismaClient는 “프로젝트 전체에서 단 한 번만 생성”하고
 * 모든 모듈이 공통으로 재사용하는 싱글톤 구조가 필수다.
 *
 * &) 문제 상황의 원인
 * Node.js는 모듈을 import할 때마다 코드를 실행할 수 있기 때문에
 * 잘못된 구조에서는 PrismaClient가 여러 번 생성될 위험이 있다.
 * 특히 개발 환경에서는 파일이 자주 리로드되어
 * 의도치 않은 다중 연결 문제가 발생하기 쉽다.
 *
 * -------------------------------
 * [실무에서 실제로 자주 발생하는 오류들]
 * -------------------------------
 *
 * 1) PrismaClient를 라우터/서비스 안에서 새로 생성하는 경우
 *    → 요청마다 DB 커넥션이 새로 열림
 *    → 연결 수 초과로 DB가 죽거나, 응답이 엄청 느려짐
 *
 * 2) 개발 환경(Hot Reload)에서 중복 생성
 *    → 파일이 저장될 때마다 서버 리로드 → PrismaClient도 여러 개 생성
 *    → "PrismaClientInitializationError", "P1000" 등 발생
 *
 * 3) DB 로그 설정이 파일마다 제각각
 *    → 어디선 로그가 나오고 다른 곳에서는 안 나와서 디버깅 난이도 증가
 *
 * 4) 여러 서비스가 서로 다른 Prisma 인스턴스를 불러 쓰는 구조
 *    → 트랜잭션, 연결 상태가 꼬여 예상치 못한 데이터 불일치가 생김
 *
 * -------------------------------
 * [공용 Prisma Singleton이 필요한 이유]
 * -------------------------------
 * - PrismaClient를 “한 번만 생성”하고 전역적으로 공유할 수 있다.
 * - DB 연결 수를 최소로 유지해 안정성을 확보한다.
 * - 로그 옵션을 환경 변수로 제어할 수 있어 개발/운영 모드 구분이 깔끔하다.
 * - 모든 서비스/컨트롤러가 동일한 인스턴스를 사용하므로
 *   트랜잭션 처리와 상태 관리가 일관된다.
 *
 * 결국 Prisma는 단일 인스턴스로 관리해야 하고,
 * config 폴더 아래에서 중앙집중적으로 초기화하는 방법이
 * 실무에서도 가장 안정적인 구조다.
 */
